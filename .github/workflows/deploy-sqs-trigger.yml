name: Deploy SQS Trigger Lambda

on:
  push:
    branches: [ master ]
    paths:
      - 'sqs_ecs_trigger.py'
      - '.github/workflows/deploy-sqs-trigger.yml'

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        mkdir -p package
        pip install --target ./package boto3
        cp sqs_ecs_trigger.py package/
    
    - name: Create deployment package
      run: |
        cd package
        zip -r ../sqs_trigger_lambda.zip .
        cd ..
    
    - name: Deploy to Lambda
      run: |
        # Check if function exists
        if aws lambda get-function --function-name scheduling-solver-sqs-trigger --region us-east-1 2>/dev/null; then
          echo "Updating existing Lambda function..."
          aws lambda update-function-code \
            --function-name scheduling-solver-sqs-trigger \
            --zip-file fileb://sqs_trigger_lambda.zip \
            --region us-east-1
        else
          echo "Lambda function doesn't exist - please create it manually first"
          exit 1
        fi
    
    - name: Update environment variables
      run: |
        aws lambda update-function-configuration \
          --function-name scheduling-solver-sqs-trigger \
          --environment "Variables={
            ECS_CLUSTER=scheduling-solver-cluster,
            ECS_TASK_DEFINITION=solver-worker,
            S3_RESULTS_BUCKET=scheduling-solver-results,
            AWS_REGION=us-east-1
          }" \
          --region us-east-1
    
    - name: Wait for update to complete
      run: |
        echo "Waiting for Lambda update to complete..."
        aws lambda wait function-updated \
          --function-name scheduling-solver-sqs-trigger \
          --region us-east-1
    
    - name: Verify deployment
      run: |
        aws lambda get-function \
          --function-name scheduling-solver-sqs-trigger \
          --region us-east-1 \
          --query 'Configuration.[FunctionName,Runtime,LastModified,State]' \
          --output table
    
    - name: Clean up
      run: |
        rm -rf package
        rm sqs_trigger_lambda.zip
